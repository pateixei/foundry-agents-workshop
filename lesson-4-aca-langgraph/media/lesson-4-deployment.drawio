<mxfile host="65bd71144e">
    <diagram id="lesson4-deployment" name="Lesson 4 - Processo de Deployment: ACA LangGraph Connected Agent">
        <mxGraphModel dx="1245" dy="668" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="900" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="title" value="Lesson 4 - Processo de Deployment: ACA LangGraph (Connected Agent)" style="text;html=1;fontSize=20;fontStyle=1;align=center;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#333333;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="300" y="20" width="1000" height="40" as="geometry"/>
                </mxCell>
                <!-- Step 1: Build Image -->
                <mxCell id="step1_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#E3F2FD;strokeColor=#1565C0;strokeWidth=2;arcSize=6;" parent="1" vertex="1">
                    <mxGeometry x="60" y="80" width="1480" height="130" as="geometry"/>
                </mxCell>
                <mxCell id="step1_num" value="1" style="ellipse;whiteSpace=wrap;html=1;fillColor=#1565C0;strokeColor=none;fontSize=18;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
                    <mxGeometry x="75" y="90" width="35" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step1_title" value="Build da imagem no ACR" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#1565C0;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="92" width="300" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="step1_desc" value="Construir a imagem Docker do agente LangGraph + FastAPI no ACR.&lt;br&gt;Mesmas tools da licao 3, mas servidor HTTP diferente (FastAPI ao inves de agentserver adapter)." style="text;html=1;fontSize=10;align=left;fillColor=none;strokeColor=none;fontColor=#555555;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="120" width="500" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step1_cmd" value="az acr build --registry acr123 --image aca-lg-agent:v1 --file Dockerfile . --no-logs" style="shape=mxgraph.basic.rect;fillColor=#263238;strokeColor=#37474F;fontSize=10;fontColor=#4FC3F7;fontFamily=Consolas;align=left;spacingLeft=10;whiteSpace=wrap;verticalAlign=middle;arcSize=6;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="100" width="520" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step1_result" value="Resultado:&#xa;acr123.azurecr.io/aca-lg-agent:v1" style="shape=note;html=1;size=12;fillColor=#E3F2FD;strokeColor=#1565C0;fontSize=9;align=left;spacingLeft=5;whiteSpace=wrap;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="145" width="250" height="45" as="geometry"/>
                </mxCell>
                <!-- Arrow 1→2 -->
                <mxCell id="arrow12" value="" style="shape=flexArrow;fillColor=#1565C0;strokeColor=none;startWidth=12;endWidth=12;startSize=5;endSize=5;opacity=60;" parent="1" vertex="1">
                    <mxGeometry x="760" y="218" width="80" height="20" as="geometry"/>
                </mxCell>
                <!-- Step 2: Deploy ACA via Bicep -->
                <mxCell id="step2_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#E0F7FA;strokeColor=#00838F;strokeWidth=2;arcSize=6;" parent="1" vertex="1">
                    <mxGeometry x="60" y="250" width="1480" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="step2_num" value="2" style="ellipse;whiteSpace=wrap;html=1;fillColor=#00838F;strokeColor=none;fontSize=18;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
                    <mxGeometry x="75" y="260" width="35" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step2_title" value="Deploy ACA via Bicep" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#00838F;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="262" width="300" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="step2_desc" value="Bicep cria: ACA Environment (conectado ao Log Analytics) + Container App com ingress externo.&lt;br&gt;Container App tem System Managed Identity, imagem do ACR, e env vars para OpenAI." style="text;html=1;fontSize=10;align=left;fillColor=none;strokeColor=none;fontColor=#555555;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="290" width="550" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step2_cmd" value="az deployment group create --resource-group rg-ag365sdk --template-file aca.bicep --parameters ..." style="shape=mxgraph.basic.rect;fillColor=#263238;strokeColor=#37474F;fontSize=10;fontColor=#4FC3F7;fontFamily=Consolas;align=left;spacingLeft=10;whiteSpace=wrap;verticalAlign=middle;arcSize=6;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="270" width="520" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step2_resources" value="Recursos criados:&#xa;- aca-env-ag365 (ACA Environment)&#xa;- aca-lg-agent (Container App, porta 8080)&#xa;- System Managed Identity" style="shape=note;html=1;size=12;fillColor=#E0F7FA;strokeColor=#00838F;fontSize=9;align=left;spacingLeft=5;whiteSpace=wrap;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="315" width="250" height="60" as="geometry"/>
                </mxCell>
                <!-- Arrow 2→3 -->
                <mxCell id="arrow23" value="" style="shape=flexArrow;fillColor=#00838F;strokeColor=none;startWidth=12;endWidth=12;startSize=5;endSize=5;opacity=60;" parent="1" vertex="1">
                    <mxGeometry x="760" y="398" width="80" height="20" as="geometry"/>
                </mxCell>
                <!-- Step 3: RBAC -->
                <mxCell id="step3_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#FFF8E1;strokeColor=#F9A825;strokeWidth=2;arcSize=6;" parent="1" vertex="1">
                    <mxGeometry x="60" y="430" width="1480" height="110" as="geometry"/>
                </mxCell>
                <mxCell id="step3_num" value="3" style="ellipse;whiteSpace=wrap;html=1;fillColor=#F9A825;strokeColor=none;fontSize=18;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
                    <mxGeometry x="75" y="440" width="35" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step3_title" value="RBAC - Managed Identity do ACA" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#F57F17;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="442" width="350" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="step3_desc" value="A MI do Container App precisa de &lt;b&gt;Cognitive Services OpenAI User&lt;/b&gt; no Foundry account.&lt;br&gt;Diferente dos hosted agents (MI do projeto), aqui e a MI propria do ACA." style="text;html=1;fontSize=10;align=left;fillColor=none;strokeColor=none;fontColor=#555555;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="472" width="550" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step3_cmd" value="az role assignment create --assignee-object-id &lt;ACA_PRINCIPAL&gt; --role &quot;Cognitive Services OpenAI User&quot; --scope &lt;FOUNDRY_SCOPE&gt;" style="shape=mxgraph.basic.rect;fillColor=#263238;strokeColor=#37474F;fontSize=9;fontColor=#FFE082;fontFamily=Consolas;align=left;spacingLeft=10;whiteSpace=wrap;verticalAlign=middle;arcSize=6;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="450" width="520" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step3_note" value="Nao precisa AcrPull (admin creds via Bicep secrets)" style="shape=note;html=1;size=12;fillColor=#FFF8E1;strokeColor=#F9A825;fontSize=9;align=left;spacingLeft=5;whiteSpace=wrap;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="495" width="300" height="30" as="geometry"/>
                </mxCell>
                <!-- Arrow 3→4 -->
                <mxCell id="arrow34" value="" style="shape=flexArrow;fillColor=#F9A825;strokeColor=none;startWidth=12;endWidth=12;startSize=5;endSize=5;opacity=60;" parent="1" vertex="1">
                    <mxGeometry x="760" y="548" width="80" height="20" as="geometry"/>
                </mxCell>
                <!-- Step 4: Register in Foundry -->
                <mxCell id="step4_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#F3E5F5;strokeColor=#7B1FA2;strokeWidth=2;arcSize=6;" parent="1" vertex="1">
                    <mxGeometry x="60" y="580" width="1480" height="130" as="geometry"/>
                </mxCell>
                <mxCell id="step4_num" value="4" style="ellipse;whiteSpace=wrap;html=1;fillColor=#7B1FA2;strokeColor=none;fontSize=18;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
                    <mxGeometry x="75" y="590" width="35" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step4_title" value="Registrar como Connected Agent no Foundry" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#7B1FA2;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="592" width="450" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="step4_desc" value="No portal Foundry (new): Operate &gt; Register agent.&lt;br&gt;O Foundry cria um proxy via AI Gateway (APIM) e gera uma URL para clientes." style="text;html=1;fontSize=10;align=left;fillColor=none;strokeColor=none;fontColor=#555555;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="620" width="550" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step4_fields" value="Agent URL:  https://aca-lg-agent.&lt;region&gt;.azurecontainerapps.io&#xa;Protocol:  HTTP&#xa;Project:   ag365-prj001&#xa;Agent name: aca-lg-agent" style="shape=mxgraph.basic.rect;fillColor=#263238;strokeColor=#37474F;fontSize=9;fontColor=#CE93D8;fontFamily=Consolas;align=left;spacingLeft=10;whiteSpace=wrap;verticalAlign=top;spacingTop=5;arcSize=6;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="590" width="400" height="65" as="geometry"/>
                </mxCell>
                <mxCell id="step4_result" value="Foundry gera URL proxy:&#xa;https://apim-&lt;foundry&gt;.azure-api.net/aca-lg-agent/" style="shape=note;html=1;size=12;fillColor=#F3E5F5;strokeColor=#7B1FA2;fontSize=9;align=left;spacingLeft=5;whiteSpace=wrap;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="665" width="350" height="35" as="geometry"/>
                </mxCell>
                <!-- Arrow 4→5 -->
                <mxCell id="arrow45" value="" style="shape=flexArrow;fillColor=#7B1FA2;strokeColor=none;startWidth=12;endWidth=12;startSize=5;endSize=5;opacity=60;" parent="1" vertex="1">
                    <mxGeometry x="760" y="718" width="80" height="20" as="geometry"/>
                </mxCell>
                <!-- Step 5: Test -->
                <mxCell id="step5_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#E8F5E9;strokeColor=#2E7D32;strokeWidth=2;arcSize=6;" parent="1" vertex="1">
                    <mxGeometry x="60" y="750" width="1480" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="step5_num" value="5" style="ellipse;whiteSpace=wrap;html=1;fillColor=#2E7D32;strokeColor=none;fontSize=18;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
                    <mxGeometry x="75" y="760" width="35" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step5_title" value="Testar o agente" style="text;html=1;fontSize=14;fontStyle=1;align=left;fillColor=none;strokeColor=none;fontColor=#2E7D32;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="762" width="300" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="step5_desc" value="Testar via chamada direta ao ACA ou via Foundry proxy.&lt;br&gt;O endpoint /docs no ACA fornece Swagger UI interativo." style="text;html=1;fontSize=10;align=left;fillColor=none;strokeColor=none;fontColor=#555555;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="120" y="790" width="500" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="step5_cmd" value="# Direto ao ACA&#xa;python chat.py --lesson 4 --endpoint https://aca-lg-agent.&lt;region&gt;.azurecontainerapps.io&#xa;&#xa;# Via curl&#xa;curl -X POST https://aca-lg-agent.&lt;region&gt;.azurecontainerapps.io/chat -H 'Content-Type: application/json' -d '{&quot;message&quot;:&quot;Qual a cotacao da PETR4?&quot;}'" style="shape=mxgraph.basic.rect;fillColor=#263238;strokeColor=#37474F;fontSize=9;fontColor=#A5D6A7;fontFamily=Consolas;align=left;spacingLeft=10;whiteSpace=wrap;verticalAlign=top;spacingTop=5;arcSize=6;labelBackgroundColor=none;" parent="1" vertex="1">
                    <mxGeometry x="700" y="760" width="520" height="90" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>
