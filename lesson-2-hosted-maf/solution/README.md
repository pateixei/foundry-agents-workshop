# Lesson 1: Financial Market Agent with Microsoft Agent Framework

## Objective

In this lesson, you will create and deploy an AI agent using the **Microsoft Agent Framework** (MAF) in Microsoft Foundry. The agent specializes in financial markets and exposes Python tools to query quotes, exchange rates, and market summaries.

## Architecture

```
Foundry Project (ag365-prj001)
  |
  +-- Hosted Agent (fin-market-agent)
        |-- Microsoft Agent Framework (Python)
        |-- Model: gpt-4.1 (Azure OpenAI)
        |-- Tools: get_stock_quote, get_exchange_rate, get_market_summary
        |-- Identity: Managed Identity
        |-- Observability: OpenTelemetry -> Azure Monitor
```

## Project Structure

```
lesson-2-hosted-maf/solution/
  agent.yaml           # Agent manifest (name, runtime, model, tools, otel)
  app.py               # HTTP server (agentserver-agentframework)
  Dockerfile           # Container image for deployment
  # create_hosted_agent.py moved to prereq/
  deploy.ps1           # Automated deployment script (az CLI)
  test_agent.py        # Console client that tests the agent via Foundry backend
  requirements.txt     # Python dependencies (pinned)
  .env                 # Environment variables (auto-generated by deploy)
  src/
    __init__.py
    main.py            # Entrypoint: run(user_input, thread_id) function
    agent/
      __init__.py
      finance_agent.py # Agent class (AzureAIClient + tools)
  tools/
    __init__.py
    finance_tools.py   # Tool functions exposed to the agent
```

## Prerequisites

1. Infrastructure provisioned via `prereq/deploy.ps1`
2. Azure CLI (`az`) installed and authenticated
3. Python 3.10+
4. Docker (for image build)
5. Agent published as Hosted Agent in Foundry (for tests via `test_agent.py`)

## Quick Deploy

```powershell
cd lesson-1/foundry-agent
.\deploy.ps1
```

The script automatically:
1. Gets outputs from Bicep deployment (endpoint, model, ACR)
2. Builds Docker image in ACR
3. Assigns RBAC roles (AcrPull + Cognitive Services OpenAI User)
4. Creates new hosted agent version via `az cognitiveservices agent`
5. Starts the agent
6. Waits for agent to become Running

## Manual Usage

### Configure environment

```bash
pip install -r requirements.txt
```

Edit the `.env`:

```
FOUNDRY_PROJECT_ENDPOINT=https://<foundry>.services.ai.azure.com/api/projects/<project>
FOUNDRY_MODEL_DEPLOYMENT_NAME=gpt-4.1
APPLICATIONINSIGHTS_CONNECTION_STRING=InstrumentationKey=...
```

### Test the agent (console client -> Foundry backend)

```bash
# Tests the hosted agent in Foundry via Responses API
python test_agent.py

# Options
python test_agent.py --endpoint <project-endpoint>
python test_agent.py --agent-name <name> --agent-version <version>
```

## Technologies

| Component | Technology |
|-----------|-----------|
| Framework | Microsoft Agent Framework (`agent-framework-azure-ai`) |
| Model | gpt-4.1 via Azure OpenAI (Foundry) |
| HTTP Server | `azure-ai-agentserver-agentframework` |
| Identity | Managed Identity (`DefaultAzureCredential`) |
| Observability | OpenTelemetry + Azure Monitor |
| Container | Docker -> Azure Container Registry |
| Hosting | Microsoft Foundry Hosted Agent |

## Available Tools

| Tool | Description |
|------|-----------|
| `get_stock_quote(ticker)` | Stock quotes (PETR4, VALE3, AAPL, MSFT, etc.) |
| `get_exchange_rate(pair)` | Exchange rate (USD/BRL, EUR/BRL, etc.) |
| `get_market_summary(market)` | Market summary (brazil, usa, europe, global) |

## Observability

The agent exports traces via OpenTelemetry to Azure Monitor (Application Insights):

- **Span `agent_run`**: Each agent execution with attributes `user_input`, `thread_id`, `response_length`
- **Span `create_finance_agent`**: Agent creation/initialization
- **Automatic metrics**: Latency, errors, throughput via Azure Monitor SDK

Visualize in the portal: Application Insights > Transaction Search.
